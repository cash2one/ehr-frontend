define(["require","../../app","module/config"],function(e){var t=e("../../app"),n=e("module/config");t.directive("structureSelector",["adminRequest","util","$rootScope",function(e,t,n){return{restrict:"EA",scope:{options:"=",disable:"=",require:"@",errorOption:"=",name:"@"},replace:!1,require:"?ngModel",templateUrl:"src/common/directive/structureSelector/tpl.html",compile:function(){function r(e,t){var n={};for(var i=0,s;s=e[i++];){if(s.id==t){n=s;break}if(s.children){n=r(s.children,t);if(n.id)break}}return n}function i(e,t){var n=t.parentId,i=[];while(n){var s=r(e,n);if(!s)break;i.unshift(s),n=s.parentId}return i}function s(e){var n=e.children,r=[];if(n)for(var i=0,e;e=n[i++];)r.push(e),e.children&&t.merge(r,s(e));return r}function o(e){if(!e)return[];var t=e.children,n=[];if(t)for(var r=0,e;e=t[r++];)n.push(e.id);return n}return{pre:function(e,n,r,i){e.optableNodes=[],e.opts={isSelectable:function(n){var r=t.findIndexInObjArr(e.optableNodes,"id",n.id);return r!=-1}}},post:function(u,a,f,l){function c(e){u.selectedNode=r(u.structureData,e),u.expandedNodes=i(u.structureData,u.selectedNode),u.paintName(u.selectedNode)}u.options=u.options||{},u.options.manageNodes=u.options.manageNodes||[];if(u.options&&u.options.manageNodes&&!u.options.manageNodes instanceof Array){console.error("组织架构数的manageNodes必须是数组");return}u.status={},u.status.isopen=!1,u.structureData=[],u.nodeFilter=function(e){var n=t.findIndexInObjArr(u.visibleNodes,"id",e.id);return n!=-1},u.paintName=function(e){var t=i(u.structureData,e),n=[];for(var r=0,s;s=t[r++];)n.push(s.label);n.push(e.label),u.selectedNodeName=n.join("-")},l.$render=function(){if(l.$viewValue){var e=l.$viewValue.id;u.selectedNode=r(u.structureData,e),u.expandedNodes=i(u.structureData,u.selectedNode),u.selectedNodeName=l.$viewValue.name}else u.selectedNode=undefined,u.initExpandedData(),u.selectedNodeName=undefined},u.getStructureList=function(){e.getStructure({containDisabled:0}).then(function(e){var r=u.$root.isAgent;u.structureData=t.getTreeData(e.data),u.$root.userInfo.isAgent&&(u.structureData=t.getAgentStructure(u.structureData)),n.structureData=u.structureData,l.$viewValue&&c(l.$viewValue.id),u.initTreeAttribute()})},u.initTreeAttribute=function(){u.initSelectaleData(),u.initVisibleData(),u.initExpandedData()},u.initExpandedData=function(){if(u.selectedNode&&u.selectedNode.id)u.expandedNodes=i(u.structureData,u.selectedNode);else{var e=[],n=[];u.options.manageNodes&&u.options.manageNodes.length?n=u.options.manageNodes:n=o(u.structureData[0]);for(var s=0,a;a=n[s++];){var f=r(u.structureData,a);e.push(f),t.merge(e,i(u.structureData,f))}u.expandedNodes=e}},u.initVisibleData=function(){var e=u.structureData,n=[],s=[];u.options.manageNodes&&u.options.manageNodes.length?s=u.options.manageNodes:s=o(u.structureData[0]);for(var a=0,f;f=s[a++];)n.push(r(e,f));var l=[];for(var a=0,c;c=n[a++];){var h=i(u.structureData,c);t.merge(l,h)}u.parentNodes=l,u.visibleNodes=t.merge(l,u.childrenNodes)},u.initSelectaleData=function(){var e=u.structureData,n=[],i=[];u.options.manageNodes&&u.options.manageNodes.length?i=u.options.manageNodes:i=o(u.structureData[0]);for(var a=0,f;f=i[a++];)n.push(r(e,f));var l=[];for(var a=0,c;c=n[a++];){var h=s(c);t.merge(l,h)}t.merge(l,n),u.childrenNodes=l,u.optableNodes=l},u.onSelect=function(e){u.paintName(e),l.$setViewValue({id:e.id,name:u.selectedNodeName}),u.status.isopen=!1},u.$watch("options.manageNodes",function(e,t){e!=t&&u.structureData&&u.initTreeAttribute()},!0),u.getStructureList()}}}}}])});