define(["require","../../app","module/nameConfig","module/config","moment"],function(e){var t=e("../../app"),n=e("module/nameConfig"),r=e("module/config"),i=e("moment");t.directive("inputControl",["$filter","$timeout","ajaxService","util",function(e,t,r,s){return{restrict:"EA",scope:{options:"="},require:"?ngModel",templateUrl:"src/common/directive/inputControl/tpl.html",replace:!1,compile:function(o,u,a,f){return{pre:function(e,t,n){e.options.min=e.options.min||new Date("1900-01-01"),e.errorOption={displayName:e.options.errorDisplayName||e.options.displayName,formName:e.options.formName,name:e.options.name,mode:e.options.mode,min:e.options.min,max:e.options.max,minLength:e.options.minLength,maxLength:e.options.maxLength},e.options.mode&&e.options.mode=="nameSuggestion"&&(e.disable=e.options.disable,e.require=e.options.require),e.options.mode&&e.options.mode=="structure"&&(e.treeSelectorOptions={manageNodes:e.options.manageNodes})},post:function(o,u,a,f){function h(){var t=o.options.filter,r=o.options.mode;if(o.options.displayValue){o.displayValue=o.options.displayValue;return}if(r=="combine"){if(t){o.displayValue=e(t)({input:o.result.input,select:o.result.select});return}o.displayValue=o.result.input+o.result.select;return}if(r=="structure"){o.displayValue=o.result.value&&o.result.value.name||n.EMPTY_VALUE;return}if(o.result.value instanceof Date){var i=o.result.value.getTime();o.displayValue=e("date")(i,"yyyy-MM-dd");return}if(t){o.displayValue=e(t)(o.result.value);return}o.displayValue=s.isEmpty(o.result.value)?n.EMPTY_VALUE:o.result.value}function p(e){function r(e,t){var t=t.toLowerCase();for(var n=0;n<e.length;n++)if(t==e[n])return!0;return!1}var t=e.name.split("."),n=t[t.length-1],i=["pdf","png","jpg","jpeg","doc","docx"];return r(i,n)?!0:!1}o.result={};var l=o.options.formName,c=o.$parent;o.form=c[l];while(!o.form)c=c.$parent,o.form=c[l];o.$watch("options.min",function(e,t){o.errorOption.min=i(e).subtract(1,"day").toDate()}),o.$watch("options.max",function(e,t){o.errorOption.max=i(e).add(1,"day").toDate()}),o.fileChange=function(){o.uploadFile()},o.uploadFile=function(){var e=o.options.name,t=$("input[name="+e+"]")[0].files[0],n=o.form[o.options.name];if(t&&!p(t)){o.$apply(function(){n.$setValidity("file",!1)});return}o.$apply(function(){n.$setValidity("file",!0)}),o.fileError="";var i=new FormData;i.append("file",t),r.send("/ADD/file/file.json",{data:i,type:"file"}).then(function(e){f.$setViewValue(e.data.storageId),o.options.fileUrl=e.data.url,o.options.required&&n.$setValidity("fileRequired",!0),info("上传成功")})},f.$render=function(){o.options.mode&&o.options.mode=="combine"?f.$viewValue&&(o.result.input=f.$viewValue.inputVal,o.result.select=f.$viewValue.selectVal):o.options.mode&&o.options.mode=="selectWithInput"?f.$viewValue&&(o.result.input=f.$viewValue.inputVal,o.result.select=f.$viewValue.selectVal):o.options.mode&&o.options.mode=="file"?o.options.required&&t(function(){f.$viewValue?o.form[o.options.name].$setValidity("fileRequired",!0):o.form[o.options.name].$setValidity("fileRequired",!1)},0):o.options.mode&&o.options.mode=="checkbox"?o.result.value=!!f.$viewValue:o.result.value=f.$viewValue,h()},o.options.mode=="selectWithInput"?(o.$watch("result.input",function(e,t){f.$setViewValue({inputVal:o.result.input,selectVal:o.result.select}),h()},!0),o.$watch("result.select",function(e,t){f.$setViewValue({inputVal:o.result.input,selectVal:o.result.select}),h()},!0)):o.options.mode=="selectWithInput"||o.options.mode=="combine"?(o.$watch("result.input",function(e,t){f.$setViewValue({inputVal:o.result.input,selectVal:o.result.select}),h()},!0),o.$watch("result.select",function(e,t){f.$setViewValue({inputVal:o.result.input,selectVal:o.result.select}),h()},!0)):o.$watch("result.value",function(e,t){e!=t&&f.$setViewValue(e),h()},!0),o.$watch("options.displayValue",function(e,t){e!=t&&(o.displayValue=e)},!0)}}}}}])});