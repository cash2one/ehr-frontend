define(["require","../app","module/config","./options/baseInfo","./options/contactInfo","./options/info","./options/otherInfo","./options/educationInfo","./options/workExpInfo","module/codeConfig","../config","module/apply/config","moment"],function(e){var t=e("../app"),n=e("module/config"),r=e("./options/baseInfo"),i=e("./options/contactInfo"),s=e("./options/info"),o=e("./options/otherInfo"),u=e("./options/educationInfo"),a=e("./options/workExpInfo"),f=e("module/codeConfig"),l=f.TYPE_CODE,c=e("../config"),h=f.STAFF_STATUS_CODE,p=e("module/apply/config"),d=e("moment");t.controller("agentCtrl",["$scope","hrRequest","$stateParams","localStorage","$state","hrUtil","hrOptUtil","util","$filter",function(e,t,l,c,h,p,d,v,m){function g(){y(),b(),e.entry=="rejoin"&&d.rejoin(w)}function y(){e.entry="";switch(h.current.name){case"hr.toJoinSearchAgent":e.entry="newer";break;case"hr.rejoinAgent":e.entry="rejoin"}}function b(){e.entry=="newer"&&(e.title="办理入职手续",e.isReadOnly=!1),e.entry=="rejoin"&&(e.title="员工再入职"),e.rejoinForibidFields=["name","lawName","namePinyin","sex","birthday","beginWorkTime","isForeign","idCardNumber"];var t="agentEnterForm";e.baseOptions=r(t),e.contactOptions=i(t),e.infoOptions=s(t,e),e.otherOptions=o("otherInfoForm"),e.educationAddOptions=u("educationAddForm"),e.workExpAddOptions=a("workExpAddForm"),e.workExperienceId=[],e.eduExperienceId=[],e.isReadOnly2=!0,e.onEditPart2=N,e.cancelPart2=T,e.workExpList=[],e.educationList=[],e.submit=O}function w(t){t.staffInfo&&($.extend(!0,e,t.staffInfo),e.idCardNumber=t.idCardNumber,E(),e.getWorkExperience(),e.getEducationExperience(),e.rejoinForibidFields.forEach(function(t,n){e.baseOptions[t].disable=!0}))}function E(){e.enterTime&&(e.promiseEnterDate=new Date(e.enterTime)),e.beginWorkTime&&(e.beginWorkTime=new Date(e.beginWorkTime)),e.birthday&&(e.birthday=new Date(v.formatTime(e.birthday)+" 00:00:00")),e.leader&&(e.leader=e.leaderName+","+e.leader),e.structure={id:e.structure,name:e.structureName},e.otherOptions.resumeStorageId.fileUrl=e.resumeUrl,e.otherOptions.idCardAndContract.fileUrl=e.idCardAndContractUrl,e.otherOptions.idCardUpload.fileUrl=e.idCardUploadUrl,e.otherOptions.limitAgreement.fileUrl=e.limitAgreementUrl}function S(t){var n=e.educationList;for(var r=0,i;i=e.educationList[r++];)i.disable=!t;e.educationList=n}function x(t){var n=e.workExpList;for(var r=0,i;i=e.workExpList[r++];)i.disable=!t;e.workExpList=n}function T(){S(!1),x(!1),e.isReadOnly2=!0}function N(){S(!0),x(!0),e.isReadOnly2=!1}function C(t,n){if(t=="structure")if(!e[t]||!e[t].id)return n[t].$error.requiredSubmitted=!0,!1;return typeof e[t]=="undefined"&&t=="leader"?(n[t].$error.sugguestionRequired=!0,!1):!0}function k(e,t){var n=!0;for(var r in e)if(e.hasOwnProperty(r)){var i=e[r].name;C(i,t)||(n=!1)}return n}function L(){var t={name:e.name||e.lawName,namePinyin:e.namePinyin,sex:e.sex,degree:e.degree,lawName:e.lawName,isForeign:e.isForeign,idCardNumber:e.idCardNumber,accountLocation:e.accountLocation,birthday:e.birthday,beginWorkTime:e.beginWorkTime,type:f.AGENT_TYPE_CODE.REGULAR,mobile:e.mobile,personalEmail:e.personalEmail,promiseEnterDate:e.promiseEnterDate&&e.promiseEnterDate.getTime(),structure:e.structure&&e.structure.id,structureName:e.structure&&e.structure.name,level:e.level,position:e.position,leader:v.getUsernameFromSuggestion(e.leader),workExperienceId:e.workExperienceId,eduExperienceId:e.eduExperienceId,resumeStorageId:e.resumeStorageId,idCardAndContract:e.idCardAndContract,idCardUpload:e.idCardUpload,limitAgreement:e.limitAgreement,detail:e.detail,recommendType:e.recommendType,recommendDetail:e.recommendDetail};return t}function A(t){var n=["resumeStorageId","idCardAndContract","idCardUpload","limitAgreement"];for(var r in t)n.indexOf(r)!==-1&&(e.otherOptions[r].fileUrl=undefined),e[r]=undefined;e.levelIndex=undefined,e.workExpList=[],e.educationList=[]}function O(){var n=e.agentEnterForm,r=e.otherInfoForm;n.$submitted=!0,r.$submitted=!0;var i=k(e.infoOptions,n);if(!n.$valid||!r.$valid||!i)return;var s=L(),o=t.submitPreEnterInfo,u={content:s,type:f.APPLY_CODE.AGENT_ENTER};if(e.entry=="rejoin"){var a=e.number;u.type=f.APPLY_CODE.AGENT_REJOIN,u.editedNumber=a,u.content.number=a}o(u).then(function(e){alert("系统已经接受了您的请求，开始审批流程，请注意查看审批结果邮件"),A(s),n.$submitted=!1,r.$submitted=!1})}g(),e.getLevel=function(r){r?t.getLevel({structure:e.structure.id}).then(function(t){for(var r=0,i;i=t.data[r++];)i.id=r;t.data.unshift(n.EMPTY),e.infoOptions.level.items=t.data,e.levelIndex=e.getLevelIndex(e.level)}):(e.infoOptions.level.items=[],e.infoOptions.position.items=[])},e.getPosition=function(r){r?t.getPosition({structure:e.structure.id,level:e.level}).then(function(t){t.data.unshift(n.EMPTY),e.infoOptions.position.items=t.data}):e.infoOptions.position.items=[]},e.$watch("structure",function(t,n){t!=n&&t&&t.id&&(e.getLevel(t),e.getPosition(t),n&&typeof n.id!="undefined"&&(e.level=undefined,e.position=undefined))},!0),e.$watch("levelIndex",function(t,n){t!=n&&(e.level=e.getLevelByIndex(t))},!0),e.$watch("level",function(t,n){t!=n&&(e.getPosition(t),typeof n!="undefined"&&(e.position=undefined))},!0),e.getLevelByIndex=function(t){return typeof t=="undefined"?undefined:e.infoOptions.level.items[t].name},e.getLevelIndex=function(t){var n=e.infoOptions.level.items;for(var r=0,i;i=n[r++];)if(i.name==t)return i.id},e.getEducationExperience=function(){t.getEducationExperience({number:e.number}).then(function(t){for(var n=0,r;r=t.data[n++];)r.start=new Date(r.start),r.end=new Date(r.end),e.isReadOnly2&&(r.disable=!0);e.educationList=t.data})},e.getWorkExperience=function(){t.getWorkExperience({number:e.number}).then(function(t){for(var n=0,r;r=t.data[n++];)r.start=new Date(r.start),r.end=new Date(r.end),e.isReadOnly2&&(r.disable=!0);e.workExpList=t.data})},e.educationAdd={addClick:function(){e.addingEducation=!0},onCancel:function(){var t=this;e.addingEducation=!1,t.clearInfo()},clearInfo:function(){e.educationAdd.start=undefined,e.educationAdd.end=undefined,e.educationAdd.school=undefined,e.educationAdd.discipline=undefined,e.educationAdd.degree=undefined},onSave:function(n){n.$submitted=!0;var r=this;if(!n.$valid)return;var i=e.educationAdd.start.getTime(),s=e.educationAdd.end.getTime();if(i>s){alert("结束时间必须大于开始时间");return}t.addEducationExperience({number:e.number,start:i,end:s,school:e.educationAdd.school,discipline:e.educationAdd.discipline,degree:e.educationAdd.degree}).then(function(t){info("添加成功"),e.addingEducation=!1;var o={id:t.data,start:new Date(i),end:new Date(s),school:e.educationAdd.school,discipline:e.educationAdd.discipline,degree:e.educationAdd.degree,disable:!1};e.educationList.push(o),e.eduExperienceId.push(t.data),n.$submitted=!1,r.clearInfo()})}},e.workExpAdd={addClick:function(){e.addingWorkExp=!0},onCancel:function(){var t=this;e.addingWorkExp=!1,t.clearInfo()},clearInfo:function(){e.workExpAdd.start=undefined,e.workExpAdd.end=undefined,e.workExpAdd.company=undefined,e.workExpAdd.position=undefined},onSave:function(n){n.$submitted=!0;var r=this;if(!n.$valid)return;var i=e.workExpAdd.start.getTime(),s=e.workExpAdd.end.getTime();if(i>s){alert("结束时间必须大于开始时间");return}t.addWorkExperience({number:e.number,start:i,end:s,company:e.workExpAdd.company,position:e.workExpAdd.position}).then(function(t){info("添加成功"),e.addingWorkExp=!1;var o={id:t.data,start:new Date(i),end:new Date(s),company:e.workExpAdd.company,position:e.workExpAdd.position,disable:!1};e.workExpList.push(o),e.workExperienceId.push(t.data),n.$submitted=!1,r.clearInfo()})}}}])});