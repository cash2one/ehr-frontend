define(["require","../app","./options","./educationInfo","./workExpInfo","module/config","module/codeConfig","../config","moment"],function(e){var t=e("../app"),n=e("./options"),r=e("./educationInfo"),i=e("./workExpInfo"),s=e("module/config"),o=e("module/codeConfig"),u=e("../config"),a=e("moment");t.controller("hrBaseInfoCtrl",["$scope","hrRequest","$stateParams","localStorage","$state","authUtil","hrUtil","util","workInfo","hrOptUtil",function(e,t,f,l,c,h,p,d,v,m){function E(t){var n=$.extend(!0,{},e.educationList);for(var r=0,i;i=n[r++];)i.disable=!t;e.educationList=n}function S(t){var n=$.extend(!0,{},e.workExpList);for(var r=0,i;i=n[r++];)i.disable=!t;e.workExpList=n}function x(){for(var t=0,n;n=b[t++];)e.baseOptions[n].disable=!1}function T(){e.isReadOnly=!0,e.disbaleBaseInput(),e.getBaseInfo()}function N(){E(!1),S(!1),e.isReadOnly2=!0,e.getEducationExperience(),e.getWorkExperience()}function C(){e.commonInfo.type==o.AGENT_TYPE_CODE.REGULAR&&(e.isAgent=1),e.entryName=="subordinate.self.baseInfo"?(e.canEditBaseInfo=!0,e.canEditWorkEduInfo=!1,e.showModMobile=!0,e.isSelfView=!0):e.entryName=="subordinate.info.baseInfo"?(e.canEditBaseInfo=!1,e.canEditWorkEduInfo=!1):(p.initEntryHRType(e),e.isFromRelationshipHR&&(e.canEditBaseInfo=!0,e.canEditWorkEduInfo=!0),e.isFromHRBP&&(e.canEditBaseInfo=!0,e.canEditWorkEduInfo=!0)),e.disbaleBaseInput(),e.getBaseInfo(),p.initCommonInfo(e),e.baseOptions=n("baseInfoForm",e,h,v,p,b),e.staffType!==1&&(e.baseOptions.formalDate.forbid=!0),e.disbaleBaseInput(e.baseOptions),e.getEducationExperience(),e.getWorkExperience(),k()}function k(){if(e.isFromSalaryHR||e.isFromTrainingHR)e.canDownLoadFile=!1}function L(){e.isSelfView?x():e.enableBaseInput(),e.isReadOnly=!1}function A(){E(!0),S(!0),e.isReadOnly2=!1}function O(){m.validatePassword(e.number,M)}function M(t){t.hadSuccess&&m.modMobile(e.number,t.password,_)}function _(t){t.hadSuccess&&(e.mobile=t.mobile)}function D(t){t&&!e.isReadOnly&&(e.staffType===1?(e.baseOptions.formalDate.items=[{id:1,name:a(t).add(3,"month").format("YYYY/MM/DD")},{id:2,name:a(t).add(6,"month").format("YYYY/MM/DD")}],e.formalDate=2,e.contractEndDate=new Date(a(t).add(3,"year").format())):(e.formalDate=undefined,e.contractEndDate=new Date(a(t).add(6,"month").format())),e.baseOptions.contractEndDate.displayValue=a(e.contractEndDate).subtract(1,"day").format("YYYY-MM-DD"))}e.number=l.get("number");var v=v.data,g="",y="";e.isSelfView=!1;var b=["hometown","ethnic","politicalStatus","birthplace","accountLocation","religion","maritalStatus","citizenship"],w={};e.entryName=c.current.name,e.educationAddOptions=r("educationAddForm"),e.workExpAddOptions=i("workExpAddForm"),e.isReadOnly=!0,e.isReadOnly2=!0,e.onEdit=L,e.onEditPart2=A,e.canDownLoadFile=!0,e.modMobileClick=O,e.cancelPart1=T,e.cancelPart2=N,e.showModMobile=!1,e.disbaleBaseInput=function(){p.disableOptions(e.baseOptions);if(e.educationList)for(var t=0,n;n=e.educationList[t++];)n.disable=!0;if(e.workExpList)for(var t=0,n;n=e.workExpList[t++];)n.disable=!0},e.enableBaseInput=function(){p.enableOptions(e.baseOptions),e.commonInfo.status!=o.STAFF_STATUS_CODE.TO_JOIN&&(e.baseOptions.enterTime.disable=!0,e.baseOptions.formalDate.disable=!0),e.baseOptions.contractEndDate.disable=!0},e.getBaseInfo=function(){t.getStaffBaseInfo({number:e.number}).then(function(t){for(var n in t.data)t.data.hasOwnProperty(n)&&(e[n]=t.data[n]);e.birthday&&(e.birthday=new Date(d.formatTime(e.birthday)+" 00:00:00")),e.beginWorkTime&&(e.beginWorkTime=new Date(e.beginWorkTime)),e.enterTime&&(g=e.enterTime,e.enterTime=new Date(e.enterTime),e.staffType===1&&(e.baseOptions.formalDate.items=[{id:1,name:a(e.enterTime).add(3,"month").format("YYYY/MM/DD")},{id:2,name:a(e.enterTime).add(6,"month").format("YYYY/MM/DD")}])),e.formalDate>0&&(y=e.formalDate,e.baseOptions.formalDate.displayValue=a(e.formalDate).format("YYYY-MM-DD"),+a(e.enterTime).add(3,"month").format("YYYYMMDD")==+a(e.formalDate).format("YYYYMMDD")?e.formalDate=1:+a(e.enterTime).add(6,"month").format("YYYYMMDD")==+a(e.formalDate).format("YYYYMMDD")?e.formalDate=2:e.formalDate=new Date(e.formalDate)),e.contractEndDate&&(e.contractEndDate=new Date(e.contractEndDate),e.baseOptions.contractEndDate.displayValue=a(e.contractEndDate).format("YYYY-MM-DD")),e.baseOptions.idCardAndContract.fileUrl=e.idCardAndContractFile,e.baseOptions.idCardUpload.fileUrl=e.idCardUploadFile,e.baseOptions.limitAgreement.fileUrl=e.limitAgreementFile,e.baseOptions.resume.fileUrl=e.resumeFile})},e.saveBaseInfo=function(n){if(!n.$valid)return;if(e.commonInfo.status==o.STAFF_STATUS_CODE.TO_JOIN&&e.staffType===1){if(!e.formalDate){alert("请选择转正日期");return}e.formalDate=new Date(e.baseOptions.formalDate.items[e.formalDate-1].name)}e.staffType!==1&&(e.formalDate=undefined),y&&e.commonInfo.status!==o.STAFF_STATUS_CODE.TO_JOIN&&(e.formalDate=new Date(y));var r={number:e.number,hometown:e.hometown,ethnic:e.ethnic,politicalStatus:e.politicalStatus,birthplace:e.birthplace,accountLocation:e.accountLocation,degree:e.degree,religion:e.religion,maritalStatus:e.maritalStatus,citizenship:e.citizenship,isForeign:e.isForeign,birthday:e.birthday&&(new Date(e.birthday)).getTime(),accountType:e.accountType,beginWorkTime:e.beginWorkTime&&(new Date(e.beginWorkTime)).getTime(),isGraduate:e.isGraduate,mobile:e.mobile,idCardNumber:e.idCardNumber,contractEndDate:e.contractEndDate&&e.contractEndDate.getTime(),formalDate:e.formalDate&&e.formalDate.getTime(),enterTime:e.enterTime&&e.enterTime.getTime(),idCardAndContract:e.idCardAndContract,idCardUpload:e.idCardUpload,limitAgreement:e.limitAgreement,resume:e.resume};if(r.idCardNumber&&r.isForeign==s.ID_CARD_CODE&&r.idCardNumber.length!=u.CHINESE_ID_CARD_NUMBER_LENGTH){alert("请输入18位身份证");return}if(r.enterTime!=g&&!d.validateLast7Day("入职日期",r.enterTime))return;var i=t.saveBaseInfo;if(e.isSelfView){i=t.saveBaseInfoSelf;for(var a in r)r.hasOwnProperty(a)&&$.inArray(a,b)==-1&&a!="number"&&delete r[a]}i(r).then(function(){info("保存成功"),e.isReadOnly=!0,e.disbaleBaseInput(),e.getBaseInfo()})},e.getEducationExperience=function(){t.getEducationExperience({number:e.number}).then(function(t){for(var n=0,r;r=t.data[n++];)r.start=new Date(r.start),r.end=new Date(r.end),e.isReadOnly2&&(r.disable=!0);e.educationList=t.data})},e.getWorkExperience=function(){t.getWorkExperience({number:e.number}).then(function(t){for(var n=0,r;r=t.data[n++];)r.start=new Date(r.start),r.end=new Date(r.end),e.isReadOnly2&&(r.disable=!0);e.workExpList=t.data})},e.educationAdd={addClick:function(){e.addingEducation=!0},onCancel:function(){var t=this;e.addingEducation=!1,t.clearInfo()},clearInfo:function(){e.educationAdd.start=undefined,e.educationAdd.end=undefined,e.educationAdd.school=undefined,e.educationAdd.discipline=undefined,e.educationAdd.degree=undefined},onSave:function(n){n.$submitted=!0;var r=this;if(!n.$valid)return;var i=e.educationAdd.start.getTime(),s=e.educationAdd.end.getTime();if(i>s){alert("结束时间必须大于开始时间");return}t.addEducationExperience({number:e.number,start:i,end:s,school:e.educationAdd.school,discipline:e.educationAdd.discipline,degree:e.educationAdd.degree}).then(function(t){info("添加成功"),e.addingEducation=!1,e.getEducationExperience(),n.$submitted=!1,r.clearInfo()})}},e.workExpAdd={addClick:function(){e.addingWorkExp=!0},onCancel:function(){var t=this;e.addingWorkExp=!1,t.clearInfo()},clearInfo:function(){e.workExpAdd.start=undefined,e.workExpAdd.end=undefined,e.workExpAdd.company=undefined,e.workExpAdd.position=undefined},onSave:function(n){n.$submitted=!0;var r=this;if(!n.$valid)return;var i=e.workExpAdd.start.getTime(),s=e.workExpAdd.end.getTime();if(i>s){alert("结束时间必须大于开始时间");return}t.addWorkExperience({number:e.number,start:i,end:s,company:e.workExpAdd.company,position:e.workExpAdd.position}).then(function(t){info("添加成功"),e.addingWorkExp=!1,e.getWorkExperience(),n.$submitted=!1,r.clearInfo()})}},C(),e.$watch("enterTime",function(t,n){e.isReadOnly||D(t)})}])});