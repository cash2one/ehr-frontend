define(["require","../app","module/config","module/codeConfig","module/nameConfig","../config","./colsConfig","moment"],function(e){function a(e,t,i,s,a,f,l,c){function T(){e.onSearch=N,e.onSave=A,e.onConfirm=I,e.onEdit=q,e.onOtherSalaryClick=J,e.onBatchSaveClick=D,e.onBatchConfirmClick=R,e.onSumSocialSecurityPerClick=K,e.onSumSocialSecurityComClick=Q,e.onDetailClick=G,e.onStructureChange=M;var t=u().add(-1,"M").format("YYYY-MM");e.monthMax=t,e.tableOptions={data:[],canSelect:!0,hasTwoHead:!0,totalCount:0,cols:o(e),pageSize:m,onPageChange:function(t){e.currentPage=t,k()},selectedItems:[],mainScope:e,bodyScroll:!0},e.getList=k,e.query.month=new Date(t+" 00:00:00"),L()}function N(){k(),_(e.query.structure)}function C(t){for(var r=0,s;s=t[r++];)s.i=r-1,s.rawRealDay=s.realDay,s.status==b.SAVE&&e.canEditSalary&&(s.isEdit=!0),s.staffType!=v.REGULAR&&(s.noInsurance=!0),s.welfareSalary==0&&s.welfareSalaryOri!=0&&(s.style={background:"#f2dede"}),s.structureName=i.getShortStructureName(s.structureName,g),s.staffTypeValue=s.staffTypeValue.replace(/员工/g,""),s.foreigner=s.isForeign!=n.ID_CARD_CODE,s.realSumAll=i.fix(w(s.realSum,s.yearAwardFinal)),i.isNodeSalaryHR(e.query.structure)?e.onlyViewMode=!1:e.onlyViewMode=!0;return t}function k(){if(!e.query.structure){alert("请选择组织架构");return}if(!e.query.month){alert("请输入查询月份");return}var n=(new Date).getDate(),r=(new Date).getMonth()+1,i=e.query.month.getMonth()+1,s=r-1;s==0&&(s=12),n>10?e.canEditSalary=!1:i==s?e.canEditSalary=!0:e.canEditSalary=!1;var o={pageDto:{pageNum:e.currentPage||1,pageSize:m},structure:e.query.structure,month:u(e.query.month.getTime()).format("YYYY-MM")};t.getSalaryList(o).then(function(t){e.tableOptions.data=C(t.data),e.tableOptions.totalCount=t.pageDto&&t.pageDto.count||0,$()}),e.exportUrl=z(o),e.exportMealSubsidyListUrl=X(o),e.exportWelfareSalaryListUrl=V(o)}function L(){a.getStructure().then(function(t){e.structureList=i.getSalaryNode(t.data,e);if(e.structureList.length){var n=e.structureList[0].id;e.query.structure=n,i.isNodeSalaryHR(e.query.structure)||(e.onlyViewMode=!0),_(n),g=e.structureList[0].name,k()}})}function A(t){var n=Y(t),r=e.salaryComputeForm;if(!r.$valid)return;if(!O(n))return;H([n])}function O(e){return e.realSumAll<0?(alert("实发工资不能为负数"),!1):!0}function M(t){for(var n=0,r;r=e.structureList[n++];)if(r.id==t){g=r.name;break}}function _(t){a.getStuctureInfo({id:t}).then(function(t){y=t.data,y.isPunchCard==r.PUNCH_CARD.NEED_SUBSIDY_NOT_BY_SALARY?(e.mealSubsidyToMealCard=!0,e.hasMealSubsidyList=!0):(e.mealSubsidyToMealCard=!1,e.hasMealSubsidyList=!1)})}function D(){var t=e.salaryComputeForm;if(!t.$valid)return;var n=e.tableOptions.selectedItems,r=P(n,b.SAVE);for(var i=0,s;s=r[i++];)if(!O(s))return;H(r)}function P(t,n){var r=[],i=e.tableOptions.data;for(var s=0,o;o=t[s++];)p[o.number]||o.status!=n?r.push(o):n==b.CONFIRM&&(j(o,!0),i[o.i].isEdit=!1);return r}function H(e){if(!e.length){info("保存成功");return}B(e,b.SAVE)}function B(n,r){var i="保存成功";r==b.CONFIRM&&(i="确认成功");var s=["id","realDay","executeSalary","trafficSubsidy","mobileSubsidy","mealSubsidy","otherSalary","mealPlus","recomend","houseSubsidy","specialReward","performExtSalary","performLeaveSalary","otherSubSidy","sumSalary","endowPer","unemployPer","medicalPer","injuryPer","maternityPer","sumSocialSecurityPer","personTax","houseFundPer","sumMinusPer","endowCom","unemployCom","medicalCom","injuryCom","maternityCom","sumSocialSecurityCom","houseFundCom","sumCom","detail","realSum","recommend","otherSubsidy","taxFreeSubsidy","welfareSalary"],o=[];for(var u=0,a;a=n[u++];){var f={};for(var l=0,c;c=s[l++];)f[c]=a[c];o.push(f)}t.modSalary({items:o,optType:r}).then(function(t){info(i);var s=e.tableOptions.data;for(var o=0,u;u=n[o++];){var a=s[u.i];r==b.CONFIRM&&(j(a,!0),a.isEdit=!1),a.status=r}})}function j(t,n){var r=t.i;t.executeSalaryOri!=0&&(e["realDayOptions"+r].disable=n),e["taxFreeSubsidyOptions"+r].disable=n,t.noInsurance||(e["houseFundPerOptions"+r].disable=n,e["houseFundComOptions"+r].disable=n)}function F(t){var n=e.tableOptions.data;for(var r=0,i;i=n[r++];)j(i,t)}function I(t){var n=Y(t),r=e.salaryComputeForm;if(!r.$valid)return;if(!O(n))return;U([n])}function q(e){var t=Y(e);t.isEdit=!0,j(t,!1)}function R(){var t=e.salaryComputeForm;if(!t.$valid)return;var n=e.tableOptions.selectedItems,r=P(n,b.CONFIRM);for(var i=0,s;s=r[i++];)if(!O(s))return;U(r)}function U(e){if(!e.length){info("成功");return}B(e,b.CONFIRM)}function z(e){return"EXPORT/salary/list.json?"+W(e)}function W(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&n!="pageDto"&&t.push(n+"="+e[n]);return t.join("&")}function X(e){return"EXPORT/staff/mealSubsidy.json?"+W(e)}function V(e){return"EXPORT/salary/welfareSalary.json?"+W(e)}function $(){var t=b.CONFIRM;for(var r=0;r<m;r++){var i=e.tableOptions.data[r];if(!i)break;i.performDetail!="[]"&&i.performDetail&&(i.performSalaryHtml=c.trustAsHtml('<div style="font-size:10px" class="perform-table">\n'+l.getPerformSalaryHtml(JSON.parse(i.performDetail),i.performSalary)+"</div>")),typeof i.performLeaveSalary!="undefined"&&(i.realSumHtml=dt(i.performLeaveSalary)),e["realDayOptions"+r]={required:!0,displayName:"",name:"realDay"+r,formName:"salaryComputeForm",placeholder:"",errorDisplayName:"实际出勤天数",pattern:n.BASE_REG_STR,blurHandler:Z(r),disable:i.status==t||i.executeSalaryOri==0||e.onlyViewMode},e["performSalaryOptions"+r]={required:!0,displayName:"",name:"performSalary"+r,formName:"salaryComputeForm",placeholder:"",errorDisplayName:"绩效工资",pattern:n.NEGATIVE_BASE_REG_STR,blurHandler:tt(r),disable:!0},e["houseFundPerOptions"+r]={required:!0,displayName:"",name:"houseFundPer"+r,formName:"salaryComputeForm",placeholder:"",errorDisplayName:"住房公积金",pattern:n.NEG_SIX_NUMBER_REG,blurHandler:nt(r),disable:i.status==t||i.noInsurance||e.onlyViewMode},e["houseFundComOptions"+r]={required:!0,displayName:"",name:"houseFundCom"+r,formName:"salaryComputeForm",placeholder:"",errorDisplayName:"住房公积金",pattern:n.NEG_SIX_NUMBER_REG,blurHandler:rt(r),disable:i.status==t||i.noInsurance||e.onlyViewMode},e["taxFreeSubsidyOptions"+r]={required:!0,displayName:"",name:"taxFreeSubsidy"+r,formName:"salaryComputeForm",placeholder:"",errorDisplayName:"免税所得",pattern:n.NEGATIVE_BASE_REG_STR,blurHandler:it(r),disable:i.status==t||e.onlyViewMode},e["personTaxOptions"+r]={required:!0,displayName:"",name:"personTax"+r,formName:"salaryComputeForm",placeholder:"",errorDisplayName:"个人所得税",pattern:n.BASE_REG_STR,blurHandler:st(r),disable:!0}}}function J(e){var t=Y(e);s.salaryOtherView(t,function(e){if(e.hasSuccess){var n=["mealPlus","recommend","houseSubsidy","specialReward","performExtSalary","otherSubsidy","otherSalary","sumSalary"];for(var r=0,i;i=n[r++];)t[i]=e.item[i];t.executeSalaryType!=d&&et(t),ut(t),lt(t),at(t),ct(t),ht(t)}})}function K(e){var t=Y(e);s.fiveInsuranceView(t,function(e){if(e.hasSuccess){var n=["endowPer","unemployPer","medicalPer","injuryPer","maternityPer","sumSocialSecurityPer"];for(var r=0,i;i=n[r++];)t[i]=e.item[i];lt(t),at(t),ct(t),ht(t)}})}function Q(e){var t=Y(e);s.fiveInsuranceComView(t,function(e){if(e.hasSuccess){var n=["endowCom","unemployCom","medicalCom","injuryCom","maternityCom","sumSocialSecurityCom"];for(var r=0,i;i=n[r++];)t[i]=e.item[i];ft(t),ht(t)}})}function G(e){var t=Y(e);s.salaryDetailView(t,function(e){e.hasSuccess&&(t.detail=e.item.detail,ht(t))})}function Y(t){return e.tableOptions.data[t]}function Z(e){return function(t,n){var r=Y(e),s=r.realDay;if(i.inputEmpty(t)){alert("请输入实际出勤天数");return}t=+t,r.realDay=t,r.executeSalaryType!=d&&et(r,s),r.trafficSubsidy=i.fix(r.trafficSubsidy+(r.realDay-s)*r.trafficSubsidyOri/r.maxDay),r.mobileSubsidy=i.fix(r.mobileSubsidy+(r.realDay-s)*r.mobileSubsidyOri/r.maxDay),r.mealSubsidy=i.fix(r.mealSubsidyOri*t/r.maxDay),ut(r),lt(r),at(r),ct(r),ht(r)}}function et(e,t){typeof t=="undefined"&&(t=e.realDay);var n=i.fix(w(e.executeSalary,x(S(E(e.realDay,t),e.executeSalaryOri),e.maxDay))),r=w(w(e.trafficSubsidy,e.mobileSubsidy),e.mealSubsidy),s=w(n,r);e.performSalary&&(s=w(s,e.performSalary)),e.welfareSalary&&(s=w(s,e.welfareSalary)),e.otherSalary<0&&(s=w(s,e.otherSalary));var o=i.fix(w(E(s,e.sumMinusPer),e.taxFreeSubsidy));o=i.fix(w(o,e.yearAwardFinal||0)),s>e.welfareSalaryOri&&o>e.welfareSalaryOri?e.welfareSalary?e.executeSalary=n:(e.executeSalary=E(n,e.welfareSalaryOri),e.style={background:"white"},e.welfareSalary=e.welfareSalaryOri):e.welfareSalary?(e.executeSalary=w(n,e.welfareSalary),e.welfareSalary=0):(e.executeSalary=n,e.welfareSalary=0,e.welfareSalary==0&&e.welfareSalaryOri!=0?e.style={background:"#f2dede"}:e.style={background:"white"})}function tt(e){return function(t,n){var r=Y(e);i.inputEmpty(t)?r.performSalary=0:r.performSalary=+t,ut(r),lt(r),at(r),ct(r),ht(r)}}function nt(e){return function(t,n){var r=Y(e);i.inputEmpty(t)?r.houseFundPer=0:r.houseFundPer=+t,lt(r),at(r),ct(r),ht(r)}}function rt(e){return function(t,n){var r=Y(e);i.inputEmpty(t)?r.houseFundCom=0:r.houseFundCom=+t,ft(r),ct(r),ht(r)}}function it(e){return function(t,n){var r=Y(e);i.inputEmpty(t)?r.taxFreeSubsidy=0:r.taxFreeSubsidy=+t,ct(r)}}function st(e){return function(t,n){var r=Y(e);i.inputEmpty(t)?r.personTax=0:r.personTax=+t,at(r),ct(r),ht(r)}}function ot(e,t){}function ut(e){var t=e.executeSalary;e.executeSalaryType==d&&(t=i.fix(e.executeSalary*e.realDay));var n=w(w(e.trafficSubsidy,e.mobileSubsidy),e.mealSubsidy),r=w(e.performSalary||0,e.otherSalary);e.sumSalary=i.fix(w(w(t,n),r))}function at(e){var t=w(w(e.sumSocialSecurityPer,e.houseFundPer||0),e.personTax||0);e.sumMinusPer=i.fix(t)}function ft(e){e.sumCom=i.fix(w(e.sumSocialSecurityCom,e.houseFundCom||0))}function lt(e){var t=w(e.sumSocialSecurityPer,e.houseFundPer),n=E(e.sumSalary,t);e.personTax=pt(e.staffType,e.foreigner,n),e.isDisability&&(e.personTax=x(e.personTax,2))}function ct(e){e.realSum=i.fix(w(E(e.sumSalary,e.sumMinusPer),e.taxFreeSubsidy)),e.realSumAll=i.fix(w(e.realSum,e.yearAwardFinal||0))}function ht(e){p[e.number]=!0}function pt(e,t,n){var r=t?4800:3500,s=E(n,r),o=0,u=0,a=0;return e==v.LABOR?(s=n,s<800?a=0:s<4e3?a=S(E(s,800),.2):s<25e3?a=S(s,.16):s<62500?a=E(S(s,.24),2e3):a=E(S(s,.32),7e3)):(s<=1500?(o=.03,u=0):s<=4500?(o=.1,u=105):s<=9e3?(o=.2,u=555):s<=35e3?(o=.25,u=1005):s<=55e3?(o=.3,u=2755):s<=8e4?(o=.35,u=5505):(o=.45,u=13505),a=E(S(s,o),u)),a>0?i.fix(a):0}function dt(e){var t="";return t+='<table border="1">\n    <tr>\n        <th>本月是否结清</th>\n        <th>下月需补扣</th>\n    </tr>\n    <tr>\n        <td>'+(e<0?"否":"是")+"</td>\n"+"        <td>"+ -e+"</td>\n"+"    </tr>\n"+"</table>\n",c.trustAsHtml(t)}e.currentPage=1,e.query={},e.canEditSalary=!0,e.onlyViewMode=!1;var h={},p={},d=r.SALARY_TYPE.DAY,v=r.TYPE_CODE,m=20,g="",y={},b={SAVE:1,CONFIRM:2},w=f.add,E=f.minus,S=f.multiply,x=f.div;e.optType=b,T()}var t=e("../app"),n=e("module/config"),r=e("module/codeConfig"),i=e("module/nameConfig"),s=e("../config"),o=e("./colsConfig"),u=e("moment");t.controller("hrSalaryListController",a),a.$inject=["$scope","hrRequest","util","hrOptUtil","adminRequest","bigDecimal","hrUtil","$sce"]});