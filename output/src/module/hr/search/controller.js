define(["require","../app","module/config","module/codeConfig","module/nameConfig","../config","./colsConfig","./customCols","./config","moment"],function(e){var t=e("../app"),n=e("module/config"),r=e("module/codeConfig"),i=e("module/nameConfig"),s=e("../config"),o=e("./colsConfig"),u=e("./customCols"),a=e("./config"),f=e("moment");t.controller("searchCtrl",["$scope","hrRequest","$state","hrUtil","localStorage","authUtil","util","hrOptUtil","adminUtil",function(e,t,l,c,h,p,d,v,m){function E(t){for(var r=0,i;i=t[r++];){i.canSeeInitInfo=!1;if(i.optType!=s.OPT_TYPE.SAVE&&e.isOfferSearch||e.isAssetManagerSearch||e.isItManagerSearch)i.canSeeInitInfo=!0,i.canAddAssetCode=!0;p.isRelationshipHR()&&i.status==g.TO_JOIN&&e.isToJoinSearch&&(i.canSeeJoinWork=!0),i.contractEndDate&&(i.contractEndDateValue=f(i.contractEndDate).format("YYYY-MM-DD")),(i.status==g.TO_JOIN||i.status==g.DRAFT)&&e.isAbandonSearch&&(i.canSeeAbandon=!0),(e.isSubordinateSearch||e.isOwnerSearch)&&i.hasSubordinate&&(i.canSeeSubAccount=!0),i.serialNum=(e.currentPage-1)*n.PAGE_SIZE+r}return t}function S(t){var n=s.PATH.STAFF_EXPORT;e.isRecruitHRSearch&&(n=s.PATH.NEW_STAFF_EXPORT);var r=c.getObjectQueryString(t),i=r==""?n:n+"?"+r+"&fields="+x().join(",");return i}function x(){var t=o(e),n=e.userDefineColOptions.checkedValues,r=[];for(var i=0,s;s=n[i++];){var u=t[s].field;u=="baseSalary"?(r.push("baseSalaryValue"),r.push("baseSalaryTypeValue")):u=="probationarySalary"?(r.push("probationarySalaryValue"),r.push("probationarySalaryTypeValue")):r.push(u)}return r}function A(t){for(var n=0,r;r=e.staffStatus[n++];)if(r.id==t){e.staffStatus.splice(n-1,1);return}}function O(){var e=[{id:g.HAS_JOINED,name:b[g.HAS_JOINED]},{id:g.LEAVED,name:b[g.LEAVED]}];return e.unshift(n.EMPTY),e}var g=r.STAFF_STATUS_CODE,y=g.DRAFT,b=i.STAFF_STATUS,w={};e.currentPage=1,e.pcTypeItems=d.buildSelectOpitons(i.PC_TYPE,!0),e.userDefineColConfirmHandler=function(t){e.getTableCols(),e.exportUrl=S(w)},e.getTableCols=function(){var t=o(e),n=e.userDefineColOptions.checkedValues,r=[];for(var i=0,s;s=n[i++];)t[s]&&r.push(t[s]);r.unshift(t.serialNum),r.push(t.opt),e.tableOptions.cols=r},e.onSearch=function(){e.getList()},e.getList=function(){e.showExport=!0;if(!e.query.month&&e.entryName=="hr.salaryBillSearch"){alert("请输入查询月份");return}w={pageDto:{pageNum:e.currentPage||1,pageSize:n.PAGE_SIZE}},e.isSubordinateSearch?w.searchType=s.SEARCH_TYPE.SUBORDINATE:e.isOwnerSearch?w.searchType=s.SEARCH_TYPE.OWNER:e.isAdminSearch?w.searchType=s.SEARCH_TYPE.ADMIN:e.isRecruitHRSearch||(w.searchType=s.SEARCH_TYPE.HR);for(var r in e.query)e.query.hasOwnProperty(r)&&typeof e.query[r]!="undefined"&&e.query[r]!==null&&(e.query[r]instanceof Date?w[r]=e.query[r].getTime():r=="name"&&!e.isRecruitHRSearch?w.userName=d.getUsernameFromSuggestion(e.query[r]):r=="leader"?w[r]=d.getUsernameFromSuggestion(e.query[r]):r=="structure"?w.structure=e.query.structure.id:r=="pcType"?w[r]=+e.query[r]:w[r]=e.query[r]);e.query.status?w.status=""+e.query.status:w.status=c.getFieldSet(e.staffStatus,"id").join(",");var i=t.getStaffInfo;e.isRecruitHRSearch&&(i=t.getPreEnterInfo),i(w).then(function(t){e.tableOptions.data=E(t.data),e.tableOptions.totalCount=t.pageDto&&t.pageDto.count||0}),e.exportUrl=S(w)},e.viewInitInfo=function(e){h.set("number",e),c.showInitInfo(e)},e.addAssetCodeClick=function(t){c.showAssetAddInfo(t,e.getList)},e.joinWorkClick=function(t){c.joinWork(t).then(function(t){e.getList()})},e.abandonClick=function(t){v.desertCondidate(t,function(t){t.hadSuccess&&e.getList()})},e.viewInfo=function(t,n){h.set("number",t);var r="";if(n=="newerSearch"){l.go("hr.newerEdit");return}n=="search"?(l.current.name=="hr.toJoinSearch"&&(e.isRelationshipHRSearch=!0),l.current.name=="hr.salaryBillSearch"&&(e.isSalaryHRSearch=!0),l.current.name=="admin.search"&&(e.isAdminSearch=!0),e.isBusinessPartnerHRSearch?r=l.href("hr.businessPartnerHR-staffInfo.baseInfo"):e.isTrainingHRSearch?r=l.href("hr.trainingHR-staffInfo.baseInfo"):e.isRelationshipHRSearch?r=l.href("hr.relationshipHR-staffInfo.baseInfo"):e.isSalaryHRSearch?r=l.href("hr.salaryHR-staffInfo.baseInfo"):e.isAdminSearch&&(r=l.href("admin.staffInfo.baseInfo"))):n=="subordinateSearch"&&(r=l.href("subordinate.info.baseInfo")),v.viewDetail(r,function(){e.getList()})},e.setPermission=function(e){h.set("number",e),window.location.href="#/admin/permission"},e.modKeyInfo=function(t){m.modKeyInfo(t,function(t){t.hadSuccess&&e.getList()})},e.getPreEnterStaffStatuses=function(){var e=[{id:g.DRAFT,name:b[g.DRAFT]},{id:g.TO_JOIN,name:b[g.TO_JOIN]}];return e.unshift(n.EMPTY),e},e.viewSubAccountClick=function(t){if(e.query.leader){var n=e.query.leader.split(",");e.leaderStack.push({leader:n[1],leaderName:n[0]})}else e.leaderStack.push({leader:undefined,leaderName:undefined});e.query.leader=d.getShowUserName(t.userName,t.name),e.getList()},e.returnLastLeaderClick=function(){var t=e.leaderStack.pop();t.leader?e.query.leader=d.getShowUserName(t.leader,t.leaderName):e.query.leader=undefined,e.getList()},e.entryName=l.current.name,e.showExport=!1,e.title="员工信息查询",e.query={},e.staffStatus=d.buildSelectOpitons(i.STAFF_STATUS),e.staffType=d.buildSelectOpitons(i.TYPE),e.structureOptions={},e.staffStatus.unshift(n.EMPTY),e.staffType.unshift(n.EMPTY),e.showCustomCols=!0;var T=e.userInfo.hasRoles,N=r.ROLE_TYPE,C=[];switch(e.entryName){case"hr.toJoinSearch":e.isToJoinSearch=!0,e.title="待入职员工查询",e.isHRSearch=!0,e.query.status=g.TO_JOIN,e.staffStatus=[{id:g.TO_JOIN,name:b[g.TO_JOIN]}],e.query.roleType=N.RELATIONSHIP_HR,e.structureOptions.manageNodes=T.relationshipHR,e.isRelationshipHRSearch=!0,C=a.DEFAULT_COLS.RELATIONSHIP_HR;break;case"hr.abandonSearch":e.isAbandonSearch=!0,e.title="候选人放弃",e.staffStatus=e.getPreEnterStaffStatuses(),e.structureOptions.manageNodes=T.recruitHR,C=a.DEFAULT_COLS.RECRUIT_HR;break;case"hr.assetManagerSearch":e.isAssetManagerSearch=!0,e.title="资产管理",e.showCustomCols=!1,e.query.roleType=N.ASSET_MANAGER;var k=[{id:g.TO_JOIN,name:b[g.TO_JOIN]},{id:g.HAS_JOINED,name:b[g.HAS_JOINED]}];k.unshift(n.EMPTY),e.staffStatus=k,e.structureOptions.manageNodes=T.assetManager,C=a.DEFAULT_COLS.ASSET_MANAGER;break;case"hr.itManagerSearch":e.isItManagerSearch=!0,e.title="IT管理",e.showCustomCols=!1,e.query.roleType=N.IT_OWNER;var k=[{id:g.TO_JOIN,name:b[g.TO_JOIN]},{id:g.HAS_JOINED,name:b[g.HAS_JOINED]}];k.unshift(n.EMPTY),e.staffStatus=k,e.structureOptions.manageNodes=T.itOwner,C=a.DEFAULT_COLS.IT_MANAGER;break;case"subordinate.search":e.isSubordinateSearch=!0,e.title="下属查询";var L=e.userInfo;e.userInfo.isAgent?(e.staffStatus=O(),C=a.DEFAULT_COLS.AGENT):(e.staffStatus=[{id:g.HAS_JOINED,name:b[g.HAS_JOINED]},{id:g.TO_LEAVE,name:b[g.TO_LEAVE]}],C=a.DEFAULT_COLS.MANAGER),e.query.status=g.HAS_JOINED,e.structureOptions.manageNodes=[n.STRUCTURE_ROOT_ID];break;case"subordinate.ownerSearch":e.isOwnerSearch=!0,e.title="部门员工查询";var L=e.userInfo;e.userInfo.isAgent?(e.staffStatus=O(),C=a.DEFAULT_COLS.AGENT):(A(y),C=a.DEFAULT_COLS.OWNER),e.query.status=g.HAS_JOINED,e.structureOptions.manageNodes=T.roleOwner;break;case"hr.newerSearch":e.isOfferSearch=!0,e.title="offer信息查询",e.structureOptions.manageNodes=T.recruitHR,C=a.DEFAULT_COLS.RECRUIT_HR;break;case"admin.search":e.isAdminSearch=!0,e.query.status=g.HAS_JOINED,A(y),e.showCustomCols=!1,e.structureOptions.manageNodes=[n.STRUCTURE_ROOT_ID],C=a.DEFAULT_COLS.ADMIN;break;case"hr.salaryHRSearch":e.isHRSearch=!0,e.isSalaryHRSearch=!0,e.title="员工信息查询-薪酬",e.query.status=g.HAS_JOINED,A(y),e.structureOptions.manageNodes=T.salaryHR,e.query.roleType=N.SALARY_HR,C=a.DEFAULT_COLS.SALARY_HR;break;case"hr.relationshipHRSearch":e.isHRSearch=!0,e.isRelationshipHRSearch=!0,e.title="员工信息查询-员工关系",e.query.status=g.HAS_JOINED,e.userInfo.isAgent?(e.staffStatus=O(),C=a.DEFAULT_COLS.AGENT):(A(y),C=a.DEFAULT_COLS.RELATIONSHIP_HR),e.query.roleType=N.RELATIONSHIP_HR,e.structureOptions.manageNodes=T.relationshipHR;break;case"hr.trainingHRSearch":e.isHRSearch=!0,e.isTrainingHRSearch=!0,e.title="员工信息查询-培训",e.query.roleType=N.TRAINING_HR,e.query.status=g.HAS_JOINED,A(y),e.structureOptions.manageNodes=T.trainingHR,C=a.DEFAULT_COLS.TRAINING_HR;break;case"hr.businessPartnerHRSearch":e.isHRSearch=!0,e.isBusinessPartnerHRSearch=!0,e.title="员工信息查询-HRBP",e.query.status=g.HAS_JOINED,A(y),e.structureOptions.manageNodes=T.businessPartnerHR,e.query.roleType=N.HRBP,C=a.DEFAULT_COLS.HRBP_HR}if(e.isOfferSearch||e.isAbandonSearch)e.isRecruitHRSearch=!0;e.leaderStack=[],e.tableOptions={data:[],canSelect:!0,totalCount:0,cols:[],pageSize:n.PAGE_SIZE,onPageChange:function(t){e.currentPage=t,e.getList()}},e.userDefineColOptions={data:u(e),name:"自定义显示字段",maxItems:50,checkedValues:C},e.getTableCols(),e.getList()}])});