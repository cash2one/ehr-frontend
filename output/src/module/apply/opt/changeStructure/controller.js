define(["require","../../app","./inputOptions","module/config","../../config","module/codeConfig","moment"],function(e){function f(e,t,u,f,l,c,h,p){function v(){w(),t.$watch("level",function(e,n){e!=n&&(S(e),typeof n!="undefined"&&(t.position=undefined))},!0),t.$watch("structure.id",function(e,n){e!=n&&(E(e),typeof n!="undefined"&&(t.level=undefined,t.position=undefined))},!0)}function m(e){if(!e.$valid)return;if((!t.structure||!t.structure.id)&&!t.leader&&!t.level&&!t.position){alert("请输入至少一项变更");return}if(!y())return;c.diffDaysFromNow(t.executeDate,"days")<i.EXECUTE_TIP_DAYS?confirm(i.EXECUTE_TIP,function(){g()}):g()}function g(){var e=t.workInfo,n=o().format("YYYY-MM-DD"),r=(new Date(n+" 00:00:00")).getTime(),a=t.executeDate.getTime();r==a&&(a=o(n).add(1,"days").valueOf()-1e3);var f={level:t.level||e.level,position:t.position||e.position,structure:t.structure&&t.structure.id||e.structure,leader:c.getUsernameFromSuggestion(t.leader)||e.leader},h=s.APPLY_CODE.STRUCTURE;t.isAgent&&(h=s.APPLY_CODE.AGENT_STRUCTURE),u.addApply({type:h,content:f,editedNumber:t.userCommonInfo.number,reason:t.reason,executeDate:a}).then(function(){alert(i.SUCCESS_TIP),d.hadSuccess=!0,l.dismiss(d)})}function y(){if(t.structure&&t.structure.id){var n=c.getParentKeyNodeItem(e.structureData,t.structure.id),r=c.getParentKeyNodeItem(e.structureData,t.workInfo.structure),i=[];i.push(t.workInfo.structure);var s=c.getParentIds(e.structureData,t.workInfo.structure);while(s)i.push(s),s=c.getParentIds(e.structureData,s);var o=!1;if(t.userInfo.hasRoles.businessPartnerHR&&!!t.userInfo.hasRoles.businessPartnerHR)for(var u=0,a;a=t.userInfo.hasRoles.businessPartnerHR[u++];)if(i.indexOf(a)!=-1){o=!0;break}p||(o=!1);if(!o&&n&&r&&n.id!=r.id)return alert("您没有权限进行跨公司员工调整"),!1;if(n&&r&&n.parentId!=r.parentId||!n||!r){if(!t.level)return alert("跨公司调整时请一起调整等级"),!1;if(!t.position)return alert("跨公司调整时请一起调整职位名称"),!1}}return t.level&&!t.position?(alert("调整等级时请一起调整职位名称"),!1):!0}function b(){l.dismiss(d)}function w(){h.getStaffWorkInfo({number:t.number}).then(function(e){t.workInfo=e.data,a=t.workInfo.structure,E(a)})}function E(e){e?h.getLevel({structure:e}).then(function(e){for(var n=0,i;i=e.data[n++];)i.id=i.name;e.data.unshift(r.EMPTY),t.inputOptions.level.items=e.data}):(t.inputOptions.level.items=[],t.inputOptions.position.items=[])}function S(e){e?h.getPosition({structure:t.structure&&t.structure.id||a,level:t.level}).then(function(e){e.data.unshift(r.EMPTY),t.inputOptions.position.items=e.data}):t.inputOptions.position.items=[]}t.number=f.get("number"),t.save=m,t.closeHandler=b,t.inputOptions=n("changeStructureForm",t);var d={};v()}var t=e("../../app"),n=e("./inputOptions"),r=e("module/config"),i=e("../../config"),s=e("module/codeConfig"),o=e("moment"),u={},a;t.controller("applyOptChangeStructureCtrl",f),f.$inject=["$rootScope","$scope","applyRequest","localStorage","$modalInstance","util","hrRequest","isFromHRBP"]});