define(["require","../../app","./inputOptions","module/config","../../config","module/codeConfig","moment"],function(e){function f(e,t,u,f,l,c,h){function m(){S(),T(),e.formName="changeSalaryForm",e.fiveBaseInitOptions={formName:"changeSalaryForm",required:!1,fieldName:"调整为"},e.$watch("level",function(t,n){t!=n&&(L(t),typeof n!="undefined"&&(e.position=undefined))},!0)}function g(){var t=e.userCommonInfo.type;if(t==o.INTERNS||t==o.LABOR)l.forbidFieldOfLabor(e.inputOptions,!0,e),l.forbidFieldOfLabor(e.fiveBaseOptions,!0,e);var n=e.userCommonInfo.isProbationary;n||(e.canModProbationarySalary=!1)}function y(t){function n(){return!e.level&&!e.position&&typeof e.baseSalary.inputVal=="undefined"&&typeof e.probationarySalary.inputVal=="undefined"&&typeof e.mobileSubsidy.inputVal=="undefined"&&typeof e.trafficSubsidy.inputVal=="undefined"&&!e.salaryType&&!e.socialSecurityBase&&!e.houseFundBase}function r(){return p&&p.needFiveBase?!e.endowBase&&!e.unemployBase&&!e.medicalBase&&!e.injuryBase&&!e.maternityBase:!0}if(!t.$valid)return;if(n()&&r()){alert("请输入至少一项变更");return}if(!w())return;var s=(new Date).getMonth(),o=e.executeDate.getMonth(),u=e.workInfo,a={level:e.level||u.level,position:e.position||u.position,salaryType:e.salaryType||e.salaryInfo.salaryType,socialSecurityBase:l.inputEmpty(e.socialSecurityBase)?e.salaryInfo.socialSecurityBase:+e.socialSecurityBase,houseFundBase:l.inputEmpty(e.houseFundBase)?e.salaryInfo.houseFundBase:+e.houseFundBase};p.needFiveBase&&(k(a,"endowBase"),k(a,"unemployBase"),k(a,"medicalBase"),k(a,"injuryBase"),k(a,"maternityBase"));if(!l.validateSocialAndHouseFundBase(a,p))return;E(a,"baseSalary"),E(a,"probationarySalary"),E(a,"mobileSubsidy"),E(a,"trafficSubsidy"),l.diffDaysFromNow(e.executeDate,"days")<i.EXECUTE_TIP_DAYS?confirm(i.EXECUTE_TIP,function(){b(a)}):b(a)}function b(n){var r=a().format("YYYY-MM-DD"),o=(new Date(r+" 00:00:00")).getTime(),u=e.executeDate.getTime();o==u&&(u=a(r).add(1,"days").valueOf()-1e3),t.addApply({editedNumber:e.userCommonInfo.number,type:s.APPLY_CODE.SALARY_INFO,content:n,reason:e.reason,executeDate:u}).then(function(){var t=(new Date).getMonth(),n=e.executeDate.getMonth();alert(i.SUCCESS_TIP+"审批通过后将从"+(n+1)+"月1日生效"),v.hadSuccess=!0,f.dismiss(v)})}function w(){return e.level&&!e.position?(alert("等级调整请一起调整职位名称"),!1):!0}function E(t,n){typeof e[n].inputVal!="undefined"?t[n]=h.getSalary(e[n]):t[n]=e.salaryInfo[n]||{}}function S(){c.getStaffWorkInfo({number:e.number}).then(function(t){e.workInfo=t.data;var n=e.workInfo.structure;C(n),e.workInfo.socialSecurityCity&&x(e.workInfo.socialSecurityCity)})}function x(t){c.getSocialSecurityCity({socialSecurityCity:t}).then(function(t){p=t.data[0],e.needFiveBase=p.needFiveBase})}function T(){c.getStaffSalaryInfo({number:e.number}).then(function(t){e.salaryInfo=t.data})}function N(){f.dismiss(v)}function C(t){t?c.getLevel({structure:e.workInfo.structure}).then(function(t){for(var n=0,i;i=t.data[n++];)i.id=i.name;t.data.unshift(r.EMPTY),e.inputOptions.level.items=t.data}):(e.inputOptions.level.items=[],e.inputOptions.position.items=[])}function k(t,n){t[n]=l.inputEmpty(e[n])?e.salaryInfo[n]:+e[n]}function L(t){t?c.getPosition({structure:e.workInfo.structure,level:e.level}).then(function(t){t.data.unshift(r.EMPTY),e.inputOptions.position.items=t.data}):e.inputOptions.position.items=[]}e.number=u.get("number"),e.save=y,e.closeHandler=N,e.inputOptions=n("changeSalaryForm",e),e.onGetUserCommonInfo=g;var p={},d=r.SALARY_TYPE[1].id;e.baseSalary={selectVal:d},e.probationarySalary={selectVal:d},e.mobileSubsidy={selectVal:d},e.trafficSubsidy={selectVal:d},e.canModProbationarySalary=!0;var v={};m()}var t=e("../../app"),n=e("./inputOptions"),r=e("module/config"),i=e("../../config"),s=e("module/codeConfig"),o=s.TYPE_CODE,u={},a=e("moment");t.controller("applyOptChangeSalaryCtrl",f),f.$inject=["$scope","applyRequest","localStorage","$modalInstance","util","hrRequest","hrUtil"]});