define(["require","../../app","./inputOptions","module/config","../../config","module/codeConfig","moment"],function(e){function f(e,t,u,f,l,c,h,p,d){function y(){C(),k(),M(),_(),D(),t.$watch("structure.id",function(e,n){e!=n&&(A(e),typeof n!="undefined"&&(t.level=undefined,t.position=undefined))},!0),t.$watch("level",function(e,n){e!=n&&(O(e),typeof n!="undefined"&&(t.position=undefined))},!0),t.$watch("socialSecurityCity",function(e,t){e?b(e):g={}},!0)}function b(e){h.getSocialSecurityCity({socialSecurityCity:e}).then(function(e){g=e.data[0],t.needFiveBase=g.needFiveBase,t.probationarySalary.inputVal&&(c.setDefaultSocialBase({},g,t),c.setDefaultHouseBase({},g,t))})}function w(e){var n=t.userCommonInfo.type;if(n==o.INTERNS||n==o.LABOR)return;c.setDefaultSocialBase({salary:e},g,t),c.setDefaultHouseBase({salary:e},g,t)}function E(){function e(){return g&&g.needFiveBase?!t.endowBase&&!t.unemployBase&&!t.medicalBase&&!t.injuryBase&&!t.maternityBase:!0}return(!t.structure||!t.structure.id)&&!t.leader&&!t.level&&!t.position&&!t.office&&!t.contractCompany&&!t.socialSecurityCity&&typeof t.baseSalary.inputVal=="undefined"&&typeof t.probationarySalary.inputVal=="undefined"&&typeof t.mobileSubsidy.inputVal=="undefined"&&typeof t.trafficSubsidy.inputVal=="undefined"&&!t.salaryType&&!t.socialSecurityBase&&!t.houseFundBase&&(!t.structure||!t.structure.id)&&!t.leader&&e()}function S(e){function s(e,n){e[n]=c.inputEmpty(t[n])?t.salaryInfo[n]:+t[n]}if(!e.$valid)return;if(E()){alert("请输入至少一项变更");return}if(!T())return;var n=t.workInfo,r={structure:t.structure&&t.structure.id||n.structure,leader:c.getUsernameFromSuggestion(t.leader)||n.leader,level:t.level||n.level,position:t.position||n.position,office:t.office||n.office,contractCompany:t.contractCompany||n.contractCompany,socialSecurityCity:t.socialSecurityCity||n.socialSecurityCity,salaryType:t.salaryType||t.salaryInfo.salaryType,socialSecurityBase:c.inputEmpty(t.socialSecurityBase)?t.salaryInfo.socialSecurityBase:+t.socialSecurityBase,houseFundBase:c.inputEmpty(t.houseFundBase)?t.salaryInfo.houseFundBase:+t.houseFundBase};g.needFiveBase&&g.needFiveBase&&(s(r,"endowBase"),s(r,"unemployBase"),s(r,"medicalBase"),s(r,"injuryBase"),s(r,"maternityBase"));if(!c.validateSocialAndHouseFundBase(r,g))return;N(r,"baseSalary"),N(r,"probationarySalary"),N(r,"mobileSubsidy"),N(r,"trafficSubsidy"),c.diffDaysFromNow(t.executeDate,"days")<i.EXECUTE_TIP_DAYS?confirm(i.EXECUTE_TIP,function(){x(r)}):x(r)}function x(e){var n=a().format("YYYY-MM-DD"),r=(new Date(n+" 00:00:00")).getTime(),o=t.executeDate.getTime();r==o&&(o=a(n).add(1,"days").valueOf()-1e3),u.addApply({editedNumber:t.userCommonInfo.number,type:s.APPLY_CODE.MULTIPLE,content:e,reason:t.reason,executeDate:t.executeDate.getTime()}).then(function(){var e=(new Date).getMonth(),n=t.executeDate.getMonth();H(t)?alert(i.SUCCESS_TIP+"审批通过后将从"+(n+1)+"月1日生效"):alert(i.SUCCESS_TIP),m.hadSuccess=!0,l.dismiss(m)})}function T(){if(t.structure&&t.structure.id){var n=c.getParentKeyNodeItem(e.structureData,t.structure.id),r=c.getParentKeyNodeItem(e.structureData,t.workInfo.structure),i=[];i.push(t.workInfo.structure);var s=c.getParentIds(e.structureData,t.workInfo.structure);while(s)i.push(s),s=c.getParentIds(e.structureData,s);var o=!1;if(t.userInfo.hasRoles.businessPartnerHR&&!!t.userInfo.hasRoles.businessPartnerHR)for(var u=0,a;a=t.userInfo.hasRoles.businessPartnerHR[u++];)if(i.indexOf(a)!=-1){o=!0;break}d||(o=!1);if(!o&&n&&r&&n.id!=r.id)return alert("您没有权限进行跨公司员工调整"),!1;if(n&&r&&n.parentId!=r.parentId||!n||!r){if(!t.level)return alert("跨公司调整时请一起调整等级"),!1;if(!t.position)return alert("跨公司调整时请一起调整职位名称"),!1}}return t.level&&!t.position?(alert("请一起调整职位名称"),!1):!0}function N(e,n){typeof t[n].inputVal!="undefined"?e[n]=p.getSalary(t[n]):e[n]=t.salaryInfo[n]||{}}function C(){h.getStaffWorkInfo({number:t.number}).then(function(e){t.workInfo=e.data;var n=t.workInfo.structure;A(n),b(t.workInfo.socialSecurityCity)})}function k(){h.getStaffSalaryInfo({number:t.number}).then(function(e){t.salaryInfo=e.data})}function L(){l.dismiss(m)}function A(e){e?h.getLevel({structure:e}).then(function(e){for(var n=0,i;i=e.data[n++];)i.id=i.name;e.data.unshift(r.EMPTY),t.inputOptions.level.items=e.data}):(t.inputOptions.level.items=[],t.inputOptions.position.items=[])}function O(e){e?h.getPosition({structure:t.structure.id,level:t.level}).then(function(e){e.data.unshift(r.EMPTY),t.inputOptions.position.items=e.data}):t.inputOptions.position.items=[]}function M(){h.getContractCompany().then(function(e){e.data.unshift(r.EMPTY),t.inputOptions.contractCompany.items=e.data})}function _(){h.getOffice().then(function(e){e.data.unshift(r.EMPTY),t.inputOptions.office.items=e.data})}function D(){h.getSocialSecurityCity().then(function(e){e.data.unshift(r.EMPTY),t.inputOptions.socialSecurityCity.items=e.data})}function P(){var e=t.userCommonInfo.type;if(e==o.INTERNS||e==o.LABOR)c.forbidFieldOfLabor(t.inputOptions,!0,t),c.forbidFieldOfLabor(t.fiveBaseOptions,!0,t);var n=t.userCommonInfo.isProbationary;n||(t.canModProbationarySalary=!1)}function H(e){var t=["socialSecurityCity","baseSalary","probationarySalary","socialSecurityBase","houseFundBase","trafficSubsidy","mobileSubsidy","salaryType"];g.needFiveBase&&(t.push.endowBase,t.push.unemployBase,t.push.medicalBase,t.push.injuryBase,t.push.maternityBase);for(var n=0,r;r=t[n++];)if(r=="baseSalary"||r=="probationarySalary"||r=="trafficSubsidy"||r=="mobileSubsidy"){if(typeof e[r].inputVal!="undefined")return!0}else if(typeof e[r]!="undefined")return!0;return!1}t.number=f.get("number"),t.save=S,t.closeHandler=L,t.probationarySalaryChange=w,t.inputOptions=n("changeMultipleForm",t),t.canModProbationarySalary=!0,t.onGetUserCommonInfo=P;var v=r.SALARY_TYPE[1].id;t.baseSalary={selectVal:v},t.probationarySalary={selectVal:v},t.mobileSubsidy={selectVal:v},t.trafficSubsidy={selectVal:v},t.fiveBaseInitOptions={formName:"changeMultipleForm",required:!1,fieldName:"调整为"};var m={},g={};y()}var t=e("../../app"),n=e("./inputOptions"),r=e("module/config"),i=e("../../config"),s=e("module/codeConfig"),o=s.TYPE_CODE,u={},a=e("moment");t.controller("applyOptMultipleCtrl",f),f.$inject=["$rootScope","$scope","applyRequest","localStorage","$modalInstance","util","hrRequest","hrUtil","isFromHRBP"]});